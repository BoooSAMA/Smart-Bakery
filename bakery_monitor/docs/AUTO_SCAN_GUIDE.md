# 🔍 自动网络扫描功能使用指南

## ✨ 功能说明

你的 Smart Bakery App 现在拥有**局域网自动扫描**功能！无需手动输入 IP 地址，一键自动发现树莓派设备。

## 🎯 三种使用方式

### 1️⃣ 首次启动 - 自动扫描
```
打开 App
  ↓
看到"请先配置连接地址"
  ↓
点击 "🔍 自动扫描" 按钮
  ↓
等待 5-20 秒（取决于网络）
  ↓
自动连接！
```

### 2️⃣ 连接失败 - 重新扫描
```
显示"无法连接到: xxx.xxx.xxx.xxx"
  ↓
点击 "🔍 自动扫描" 按钮
  ↓
自动重新搜索并连接
```

### 3️⃣ 已连接 - 快速重扫
```
顶部 IP 卡片右侧有 📡 图标
  ↓
点击雷达图标
  ↓
快速重新扫描（IP 改变时使用）
```

## 🚀 扫描原理

### 高性能并发扫描
- ✅ **不是逐个尝试**：同时扫描 50 个 IP
- ✅ **快速响应**：找到第一个设备立即停止
- ✅ **超时保护**：每个请求 2 秒超时
- ✅ **智能子网**：自动检测当前 WiFi 网段

### 扫描过程
```
1. 获取手机 IP（如 192.168.43.55）
   ↓
2. 提取子网（192.168.43.0/24）
   ↓
3. 并发扫描 192.168.43.1 ~ 192.168.43.255
   ↓
4. 测试每个 IP 的 :5000/api/status 端点
   ↓
5. 返回第一个响应 200 OK 的 IP
```

## 📱 Android 权限说明

### 为什么需要位置权限？

Android 系统要求：读取 WiFi 信息必须有位置权限

- **Android 12 及以下**：需要 `ACCESS_FINE_LOCATION`
- **Android 13+**：需要 `NEARBY_WIFI_DEVICES`

### 权限申请流程

1. 首次点击扫描
2. 弹出权限请求对话框
3. 点击"允许"
4. 开始扫描

> **注意**：如果拒绝权限，App 会提示无法扫描，但仍可手动输入 IP

## ⚡ 性能优化

### 扫描速度
- **局域网设备数量少**：5-10 秒
- **设备较多或网络慢**：15-30 秒
- **未找到设备**：约 30 秒超时

### 优化建议
```dart
// 在 network_scanner.dart 中调整参数
static const int maxConcurrentRequests = 50;  // 增大可更快，但占用资源更多
static const Duration requestTimeout = Duration(seconds: 2);  // 减小可更快，但可能漏检
```

## 🔧 技术实现

### 核心文件

1. **`lib/api/network_scanner.dart`** - 扫描引擎
   - `scanNetwork()` - 主扫描函数
   - `_checkHost()` - 测试单个 IP
   - 并发控制和进度回调

2. **`lib/screens/dashboard_page.dart`** - UI 集成
   - `_startNetworkScan()` - 触发扫描
   - 进度显示和结果处理
   - 三个入口的扫描按钮

3. **`android/app/src/main/AndroidManifest.xml`** - 权限配置
   - 位置权限声明
   - WiFi 状态权限

### 依赖包

```yaml
network_info_plus: ^5.0.3    # 获取 WiFi 信息
permission_handler: ^11.3.1   # 处理运行时权限
```

## 🎨 UI 位置

### 1. 未连接页面
```
┌─────────────────────────┐
│   🔗 请先配置连接地址    │
│                         │
│  [🔍 自动扫描] (蓝色)    │
│        或              │
│  [手动输入 IP]          │
└─────────────────────────┘
```

### 2. 连接失败页面
```
┌─────────────────────────┐
│   📡 无法连接到:         │
│   192.168.43.166        │
│                         │
│  [🔍 自动扫描]          │
│  [修改配置]             │
└─────────────────────────┘
```

### 3. 已连接 - IP 卡片
```
┌──────────────────────────────┐
│ 📶  当前连接地址         📡  │
│     192.168.43.166  [修改]    │
└──────────────────────────────┘
          ↑ 点击雷达图标快速扫描
```

## 🐛 故障排查

### 问题：扫描一直找不到设备

**可能原因：**
1. 树莓派和手机不在同一 WiFi 网络
2. 树莓派的 Flask 服务未启动
3. 防火墙阻止端口 5000
4. 树莓派 IP 不在标准子网

**解决方法：**
```bash
# 1. 在树莓派上检查服务
sudo systemctl status your-flask-service

# 2. 检查端口
sudo netstat -tlnp | grep 5000

# 3. 测试 API
curl http://localhost:5000/api/status

# 4. 查看树莓派 IP
hostname -I
```

### 问题：权限被拒绝

**解决方法：**
1. 进入手机设置
2. 找到 App 权限
3. 开启"位置"权限
4. 返回 App 重新扫描

### 问题：扫描太慢

**调整并发数：**
```dart
// lib/api/network_scanner.dart
static const int maxConcurrentRequests = 100;  // 从 50 增加到 100
```

## 💡 最佳实践

### 日常使用
1. **首次使用**：用自动扫描
2. **IP 固定后**：保存即可，无需重复扫描
3. **热点重启后**：点击雷达图标快速重扫

### 开发调试
```dart
// 在扫描前测试特定 IP
final isValid = await NetworkScanner.testIP('192.168.43.166');
print('IP valid: $isValid');
```

## 🎉 总结

现在你的 App 拥有**三种 IP 配置方式**：

| 方式 | 适用场景 | 速度 | 便捷性 |
|------|---------|------|--------|
| 🔍 自动扫描 | 不知道 IP | 慢 | ⭐⭐⭐⭐⭐ |
| ✏️ 快捷输入 | 知道 IP 格式 | 快 | ⭐⭐⭐⭐ |
| ⌨️ 完整输入 | 特殊网络 | 快 | ⭐⭐⭐ |

**推荐流程**：
1. 首次使用 → 自动扫描
2. 记住 IP 后 → 快捷输入
3. IP 改变时 → 点击雷达图标

**你的 App 现在真正做到了"开箱即用"！** 🎊
